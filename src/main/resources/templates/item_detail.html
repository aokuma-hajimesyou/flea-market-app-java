<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title th:text="${item.name} + ' - FleaMarketApp'"></title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <header class="app-header">
        <div class="header-inner">
            <h1 class="app-title"><a th:href="@{/items}">FleaMarketApp</a></h1>
        </div>
    </header>

    <div class="container">
        <div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>
        <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>

        <div class="detail-box">
            <img th:src="${item.imageUrl != null ? item.imageUrl : '/images/placeholder.png'}" alt="商品画像"
                class="item-image-main">
            
            <h1 th:text="${item.name}" style="margin-top: 0;"></h1>
            
            <p class="price">
                <span th:text="'¥' + ${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')}"></span>
            </p>

            <div class="item-info-table" style="margin-bottom: 20px;">
                <p><strong>説明:</strong> <span th:text="${item.description}"></span></p>
                <p><strong>カテゴリー:</strong> <span th:text="${item.category != null ? item.category.name : '未分類'}"></span></p>
                <p><strong>出品者:</strong> 
                    <a th:href="@{/users/{id}(id=${item.seller.id})}" th:text="${item.seller.name}" style="color: var(--accent-color);"></a>
                    <span th:if="${sellerAverageRating}" style="color: var(--text-sub); font-size: 0.9rem;">
                        <i class="fas fa-star" style="color: #ffc107;"></i> <span th:text="${sellerAverageRating}"></span>
                    </span>
                </p>
                <p><strong>ステータス:</strong> 
                    <span class="badge" th:text="${item.status}" 
                          th:style="${item.status == '出品中' ? 'background:#e1f5fe; color:#01579b; padding:2px 8px; border-radius:4px;' : 'background:#eee; padding:2px 8px; border-radius:4px;'}"></span>
                </p>
            </div>

            <div class="button-group">
                <form th:action="@{/orders/initiate-purchase}" method="post"
                    th:if="${item.status == '出品中' and item.seller.email != #authentication.name}"
                    onsubmit="return confirm('本当にこの商品を購入しますか？');" style="flex: 2;">
                    <input type="hidden" name="itemId" th:value="${item.id}">
                    <button type="submit" class="button" style="width: 100%;">
                        <i class="fas fa-shopping-cart"></i> 購入手続きへ
                    </button>
                </form>

                <div sec:authorize="isAuthenticated()" th:if="${item.seller.email != #authentication.name}" style="flex: 1;">
                    <form th:if="${isFavorited}" th:action="@{/items/{id}/unfavorite(id=${item.id})}" method="post">
                        <button type="submit" class="button danger is-favorited" style="width: 100%;">
                            <i class="fas fa-heart"></i> 解除
                        </button>
                    </form>
                    <form th:unless="${isFavorited}" th:action="@{/items/{id}/favorite(id=${item.id})}" method="post">
                        <button type="submit" class="button danger" style="width: 100%; background-color: var(--primary-color); color: white;">
                            <i class="far fa-heart"></i> お気に入り
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <h2><i class="far fa-comments"></i> コメント</h2>
        <div class="chat-box">
            <div th:each="chat : ${chats}" class="chat-message"
                th:classappend="${chat.sender.email == #authentication.name ? 'my-message' : 'other-message'}">
                <span class="sender-name" th:text="${chat.sender.name}"></span>
                <p th:text="${chat.message}" style="margin: 5px 0;"></p>
                <span class="message-time" th:text="${#temporals.format(chat.createdAt, 'MM/dd HH:mm')}"></span>
            </div>
            <div th:if="${#lists.isEmpty(chats)}" style="text-align: center; color: var(--text-sub); padding: 20px;">
                <p>まだコメントはありません。不明な点を質問してみましょう。</p>
            </div>
        </div>

        <form th:action="@{/chat/{itemId}(itemId=${item.id})}" method="post" class="chat-form">
            <textarea name="message" class="input-field" placeholder="値下げ交渉や商品状態の質問など" required></textarea>
            <button type="submit" class="button" style="background-color: var(--text-main); margin-top: 10px;">コメントを送信する</button>
        </form>

        <div class="button-group" style="margin-top: 20px;">
            <a th:href="@{/items}" class="button secondary" style="width: 100%;">
                <i class="fas fa-arrow-left"></i> 商品一覧に戻る
            </a>
        </div>
    </div>

    <div style="height: 40px;"></div>
</body>
</html>