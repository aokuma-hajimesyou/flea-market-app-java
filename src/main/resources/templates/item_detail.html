<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<title th:text="${item.name} + ' - 商品詳細'"></title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
	<div class="container">
		<h1 th:text="${item.name}"></h1>

		<div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>
		<div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>

		<div class="item-detail">
			<img th:src="${item.imageUrl != null ? item.imageUrl : '/images/placeholder.png'}" alt="商品画像"
				class="item-image">
			<p class="price">価格: <span th:text="'¥' + ${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')}"></span></p>
			<p>説明: <span th:text="${item.description}"></span></p>
			<p>カテゴリ: <span th:text="${item.category != null ? item.category.name : '未分類'}"></span></p>
			<p>出品者: <span th:text="${item.seller.name}"></span>
				<span th:if="${sellerAverageRating}">(平均評価: <span th:text="${sellerAverageRating}"></span>)</span>
			</p>
			<p>ステータス: <span th:text="${item.status}"></span></p>

			<div class="button-group">
				<form th:action="@{/orders/initiate-purchase}" method="post"
					th:if="${item.status == '出品中' and item.seller.email != #authentication.name}"
					onsubmit="return confirm('本当にこの商品を購入しますか？');">
					<input type="hidden" name="itemId" th:value="${item.id}">
					<button type="submit" class="button">購入する</button>
				</form>
				<a th:href="@{/chat/{itemId}(itemId=${item.id})}" class="button secondary">チャットで質問/交渉</a>

				<div sec:authorize="isAuthenticated()" th:if="${item.seller.email != #authentication.name}">
					<form th:if="${isFavorited}" th:action="@{/items/{id}/unfavorite(id=${item.id})}" method="post"
						style="display:inline;">
						<button type="submit" class="button danger">お気に入り解除</button>
					</form>
					<form th:unless="${isFavorited}" th:action="@{/items/{id}/favorite(id=${item.id})}" method="post"
						style="display:inline;">
						<button type="submit" class="button">お気に入りに追加</button>
					</form>
				</div>
			</div>
		</div>

		<h2>チャット</h2>
		<div class="chat-box">
			<div th:each="chat : ${chats}" class="chat-message"
				th:classappend="${chat.sender.email == #authentication.name ? 'my-message' : 'other-message'}">
				<span class="sender-name" th:text="${chat.sender.name}"></span>
				<span class="message-time" th:text="${#temporals.format(chat.createdAt, 'yyyy/MM/dd HH:mm')}"></span>
				<p th:text="${chat.message}"></p>
			</div>
			<div th:if="${#lists.isEmpty(chats)}">
				<p>まだチャットメッセージはありません。</p>
			</div>
		</div>
		<form th:action="@{/chat/{itemId}(itemId=${item.id})}" method="post" class="chat-form">
			<textarea name="message" placeholder="メッセージを入力してください" required></textarea>
			<button type="submit">送信</button>
		</form>

		<div class="button-group">
			<a th:href="@{/items}" class="button secondary">商品一覧に戻る</a>
		</div>
	</div>
</body>

</html>