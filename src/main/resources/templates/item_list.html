<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>商品一覧 - フリマアプリ</title>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" th:href="@{/css/style.css}">
	<script th:src="@{/js/style.js}"></script>
</head>

<body>
	<header class="app-header">
		<div class="header-inner">
			<h1 class="app-title"><a th:href="@{/items}">FleaMarketApp</a></h1>

			<div class="header-actions">
				<div class="notification-container">
					<a href="javascript:void(0)" class="header-link notification-icon" id="notificationBtn">
						<i class="fas fa-bell"></i>
						<span class="badge" th:if="${unreadCount > 0}" th:text="${unreadCount}"></span>
					</a>

					<div class="notification-modal" id="notificationModal">
						<div class="modal-header">
							<span>通知</span>
							<a th:href="@{/notifications/mark-all-read}" class="mark-all-link">すべて既読</a>
						</div>
						<div class="modal-body">
							<div th:each="n : ${notifications}" 
							     th:classappend="${n.isRead} ? 'notification-item read' : 'notification-item unread'">
								<a th:href="@{/notifications/{id}/read(id=${n.id})}">
									<div class="notif-title" th:text="${n.title}">通知タイトル</div>
									<div class="notif-message" th:text="${n.message}">メッセージ内容</div>
									<div class="notif-time" th:text="${#temporals.format(n.createdAt, 'MM/dd HH:mm')}">12/27 15:00</div>
								</a>
							</div>
							<div th:if="${#lists.isEmpty(notifications)}" class="no-notif">
								現在、通知はありません。
							</div>
						</div>
					</div>
				</div>

				<a th:href="@{/my-page}" class="header-link"><i class="fas fa-user"></i> マイページ</a>
				
				<form th:action="@{/logout}" method="post" style="display:inline;">
					<button type="submit" class="header-link logout-btn"><i class="fas fa-sign-out-alt"></i></button>
				</form>
			</div>
		</div>

		<div class="search-area">
			<form th:action="@{/items}" method="get" class="search-form">
				<div class="search-row">
					<div class="input-group">
						<i class="fas fa-search search-icon"></i>
						<input type="text" id="keyword" name="keyword" th:value="${param.keyword}"
							placeholder="なにをお探しですか？">
					</div>
					<div class="select-group">
						<select id="categoryId" name="categoryId" onchange="this.form.submit()">
						    <option value="">すべてのカテゴリ</option>
						    <option th:each="category : ${categories}" 
						            th:value="${category.id}"
						            th:text="${category.name}"
						            th:selected="${param.categoryId != null and param.categoryId[0] == category.id.toString()}">
						    </option>
						</select>
					</div>
					<button type="submit" class="search-btn">検索</button>
				</div>
			</form>
		</div>
	</header>

	<div class="container">
		<div class="item-grid">
			<div class="item-card" th:each="item : ${items.content}">
				<a th:href="@{/items/{id}(id=${item.id})}" class="card-link">

					<div class="image-container">
						<img th:src="${item.imageUrl != null ? item.imageUrl : '/images/placeholder.png'}" alt="商品画像"
							class="product-img">

						<div class="price-tag">
							<span class="currency">¥</span>
							<span th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')}"></span>
						</div>

						<div th:if="${item.status == 'SOLD'}" class="sold-overlay">
							<div class="sold-badge"></div>
							<span class="sold-text">SOLD</span>
						</div>
					</div>

					<div class="card-body">
						<h3 class="item-name" th:text="${item.name}">商品名</h3>
						<div class="item-footer">
							<span class="status-label" th:unless="${item.status == 'SOLD'}"
								th:text="${item.status}"></span>
							<div class="like-count" th:classappend="${item.isFavorited} ? 'is-favorited' : ''">
								<i class="fa-heart" th:classappend="${item.isFavorited} ? 'fas' : 'far'"></i>
								<span th:text="${item.favoriteCount != null ? item.favoriteCount : 0}">0</span>
							</div>
						</div>
					</div>
				</a>
			</div>
		</div>

		<div th:if="${#lists.isEmpty(items.content)}" class="no-items">
			<p>商品が見つかりませんでした。</p>
			<a th:href="@{/items}" class="reset-link">検索条件をクリア</a>
		</div>

		<div class="pagination" th:if="${items.totalPages > 0}">
			<a th:if="${items.hasPrevious()}" class="page-link prev"
				th:href="@{/items(page=${items.number - 1}, keyword=${param.keyword}, categoryId=${param.categoryId})}">
				<i class="fas fa-chevron-left"></i> 前へ
			</a>

			<div class="page-numbers">
				<span th:each="i : ${#numbers.sequence(0, items.totalPages - 1)}">
					<a th:if="${i != items.number}" class="page-link num"
						th:href="@{/items(page=${i}, keyword=${param.keyword}, categoryId=${param.categoryId})}"
						th:text="${i + 1}"></a>
					<span th:if="${i == items.number}" class="page-link current" th:text="${i + 1}"></span>
				</span>
			</div>

			<a th:if="${items.hasNext()}" class="page-link next"
				th:href="@{/items(page=${items.number + 1}, keyword=${param.keyword}, categoryId=${param.categoryId})}">
				次へ <i class="fas fa-chevron-right"></i>
			</a>
		</div>
	</div>

	<a th:href="@{/items/new}" class="fab-sell">
		<i class="fas fa-camera"></i>
		<span class="fab-text">出品</span>
	</a>

</body>

</html>